# StartUp E-commerce API (Backend)

**Este es el backend para una aplicaci√≥n de E-commerce completa, construida con Node.js, TypeScript, Express y MongoDB. Incorpora caracter√≠sticas modernas como autenticaci√≥n JWT, integraci√≥n con pasarelas de pago, gesti√≥n de productos/clientes (con** **b√∫squeda y filtrado avanzados**, **gesti√≥n de direcciones**), un carrito de compras, sistema de cupones, un **panel de administraci√≥n API** **y un chatbot inteligente basado en RAG (Retrieval-Augmented Generation).**

## ‚ú® Caracter√≠sticas Principales

* **Autenticaci√≥n:**

  * **Registro de usuarios (con creaci√≥n autom√°tica de perfil de cliente).**
  * **Inicio de sesi√≥n con JWT (JSON Web Tokens).**
  * **Recuperaci√≥n de contrase√±a (solicitud y reseteo por email).**
  * **Middleware para proteger rutas (**validateJwt**).**
  * **Middleware para verificaci√≥n de roles (**checkRole**).**
* **Gesti√≥n de Productos:**

  * **CRUD completo para Productos, Categor√≠as,** **Tags (Etiquetas)** **y Unidades de medida.**
  * **B√∫squeda y Filtrado Avanzado:** **B√∫squeda por texto (nombre, descripci√≥n), filtrado por categor√≠a(s),** **etiqueta(s) (ej: "popular", "combo")**, rango de precios y ordenamiento configurable.
  * **Asociaci√≥n de productos con categor√≠as y unidades.**
  * **Etiquetado (Tags):** **Asignar m√∫ltiples etiquetas a productos para clasificaci√≥n y filtrado.**
  * **C√°lculo de precios con IVA.**
  * **Gesti√≥n de stock b√°sica (decremento al crear pedido, restauraci√≥n al cancelar).**
* **Gesti√≥n de Clientes:**

  * **CRUD completo para Clientes (con soporte para invitados).**
  * **Vinculaci√≥n de Usuarios registrados con perfiles de Cliente.**
  * **CRUD completo para Ciudades y Barrios (asociados a ciudades).**
  * **Gesti√≥n de Direcciones:**

    * **Usuarios registrados pueden a√±adir, ver, actualizar y eliminar m√∫ltiples direcciones de env√≠o.**
    * **Marcar una direcci√≥n como predeterminada.**
    * **Seleccionar direcci√≥n guardada durante el checkout.**
    * **Soporte para ingresar direcci√≥n nueva durante el checkout (registrados e invitados).**
* **Carrito de Compras:**

  * **A√±adir/actualizar/eliminar √≠tems.**
  * **Obtener el carrito del usuario actual.**
  * **Vaciar carrito.**
  * **Almacena precios y tasas de IVA al momento de agregar el √≠tem.**
* **Gesti√≥n de Pedidos (Ventas):**

  * **Creaci√≥n de pedidos usando direcci√≥n seleccionada, nueva o default.**
  * **Snapshot de la direcci√≥n de env√≠o guardado en cada pedido.**
  * **C√°lculo autom√°tico de subtotales, impuestos, descuentos y total.**
  * **Aplicaci√≥n de cupones de descuento (porcentual o fijo).**
  * **Actualizaci√≥n de estado del pedido (pendiente, completado, cancelado).**
  * **Historial de pedidos para el usuario autenticado (**/my-orders**).**
  * **B√∫squeda/listado de pedidos para administraci√≥n.**
* **Integraci√≥n de Pagos (Mercado Pago):**

  * **Creaci√≥n de preferencias de pago.**
  * **Manejo de callbacks (success, failure, pending) con redirecci√≥n al frontend.**
  * **Procesamiento de webhooks para actualizar estado de pago/pedido.**
  * **Verificaci√≥n del estado del pago/preferencia.**
  * **Soporte para claves de idempotencia.**
* **Sistema de Cupones:**

  * **CRUD completo para Cupones.**
  * **Validaciones (fechas, monto m√≠nimo, l√≠mite de uso).**
  * **Incremento autom√°tico del contador de uso.**
* **Chatbot Inteligente (RAG):**

  * **Modelo basado en Retrieval-Augmented Generation con** **Transformers.js** **y** **Langchain**.
  * **Generaci√≥n/validaci√≥n de embeddings para datos clave (Productos, Categor√≠as, Clientes, etc.).**
  * **Integraci√≥n con LLMs (OpenAI GPT, Anthropic Claude).**
  * **Modos Cliente/Due√±o y gesti√≥n de sesiones.**
* **Panel de Administraci√≥n (API):**

  * **Endpoints dedicados bajo** **/api/admin** **protegidos por rol** **ADMIN_ROLE**.
  * **Permite gestionar Productos, Categor√≠as, Unidades,** **Tags**, Pedidos, Clientes, Ciudades, Barrios, Cupones y Usuarios.
* **Subida de Im√°genes (Cloudinary):**

  * **Integraci√≥n para subir/eliminar im√°genes de productos.**
* **Notificaciones por Email (Nodemailer):**

  * **Env√≠o de correos para restablecimiento de contrase√±a.**
* **Infraestructura y Calidad:**

  * **Arquitectura en capas (Domain, Infrastructure, Presentation).**
  * **DataSources, Repositories, Casos de Uso, Mappers, DTOs.**
  * **Manejo centralizado de errores (CustomError).**
  * **Logging avanzado (Winston).**
  * **Middlewares: Rate Limiting, Logging, Autenticaci√≥n (JWT, Roles), Subida de archivos (Multer).**
  * **Variables de entorno centralizadas (**dotenv**,** **env-var**).
  * **CORS configurado.**

## üõ†Ô∏è Tecnolog√≠as Utilizadas

* **Backend:** **Node.js, Express.js**
* **Lenguaje:** **TypeScript**
* **Base de Datos:** **MongoDB con Mongoose (√çndices de Texto, Aggregation Pipeline)**
* **Autenticaci√≥n:** **JWT (jsonwebtoken), bcryptjs**
* **Pagos:** **Mercado Pago SDK (v√≠a API REST con Axios)**
* **Chatbot:** **Langchain.js, Transformers.js, OpenAI/Anthropic API**
* **Subida de Im√°genes:** **Cloudinary, Multer**
* **Emails:** **Nodemailer**
* **Logging:** **Winston, winston-daily-rotate-file**
* **Variables de Entorno:** **dotenv, env-var**
* **Rate Limiting:** **express-rate-limit**
* **Otros:** **CORS, uuid**

## üèóÔ∏è Arquitectura

El proyecto sigue una arquitectura en capas inspirada en principios de Clean Architecture:

* **Domain:** **Contiene la l√≥gica de negocio pura, entidades, casos de uso, interfaces de repositorios y datasources. No depende de frameworks ni de detalles de infraestructura.**
* **Infrastructure:** **Implementa las interfaces definidas en el dominio. Contiene los datasources concretos (ej: MongoDB), repositorios concretos, mappers y adaptadores para servicios externos (JWT, bcrypt, email, pagos, Cloudinary, etc.).**
* **Presentation:** **Expone la API REST usando Express. Contiene los controladores, rutas y middlewares. Interact√∫a con los casos de uso del dominio.**

## üìã Prerrequisitos

* **Node.js (v18+)**
* **npm o yarn**
* **MongoDB (v5+ recomendado)**
* **Cuenta de Cloudinary**
* **Cuenta de Mercado Pago**
* **Claves API para OpenAI y/o Anthropic**
* **Credenciales de un servicio de email**

## üöÄ Instalaci√≥n

* **Clona el repositorio:**

  ```
  git clone <tu-repositorio-url>
  cd <nombre-del-directorio>
  ```
* **Instala las dependencias:**

  ```
  npm install
  # o
  yarn install
  ```
* **Configura las variables de entorno (**.env**):** **(Aseg√∫rate de tener todas las claves necesarias, incluyendo** **DEFAULT_NEIGHBORHOOD_ID**)

  ```
  # Server
  PORT=3000
  NODE_ENV=development # development | production | test
  FRONTEND_URL=http://localhost:4200 # O tu URL de frontend

  # MongoDB
  MONGO_URL=mongodb://localhost:27017/ecommerce_db # Ajusta si es necesario
  MONGO_DB_NAME=ecommerce_db
  DEFAULT_NEIGHBORHOOD_ID=YOUR_DEFAULT_NEIGHBORHOOD_MONGO_ID # <-- Aseg√∫rate de tener esto

  # JWT
  JWT_SEED=TU_JWT_SEED_SECRETO

  # Mercado Pago
  MERCADO_PAGO_ACCESS_TOKEN=APP_USR-xxxxxxxxxx # Tu Access Token
  MERCADO_PAGO_PUBLIC_KEY=APP_USR-xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx # Tu Public Key

  # LLM APIs
  ANTHROPIC_API_KEY=sk-ant-api03-xxxxxxxxxx
  OPENAI_API_KEY=sk-xxxxxxxxxx

  # Webhook (Usa ngrok: https://ngrok.com/ o un servicio similar para desarrollo)
  URL_RESPONSE_WEBHOOK_NGROK=https://xxxx-xxxx-xxxx.ngrok-free.app # Reemplaza con tu URL p√∫blica

  # Cloudinary
  CLOUDINARY_CLOUD_NAME=tu_cloud_name
  CLOUDINARY_API_KEY=tu_api_key
  CLOUDINARY_API_SECRET=tu_api_secret
  CLOUDINARY_URL=cloudinary://tu_api_key:tu_api_secret@tu_cloud_name

  # Email Service (ej. Gmail App Password)
  EMAIL_SERVICE=gmail
  EMAIL_USER=tu_correo@gmail.com
  EMAIL_PASS=tu_contrase√±a_de_aplicacion
  EMAIL_SENDER_NAME="Tu Tienda Online"

  # Opcional: Log Level (debug, info, warn, error)
  # LOG_LEVEL=debug
  ```

  **content_copy**download

  Use code [with caution](https://support.google.com/legal/answer/13505487).**Env**
* **(Importante) Crear √≠ndices de MongoDB:** **Con√©ctate a tu shell de Mongo (**mongosh**) y ejecuta:**

  ```
  use ecommerce_db # O el nombre de tu BD
  db.products.createIndex({ name: "text", description: "text" }, { weights: { name: 10, description: 5 }, name: "ProductTextIndex" })
  db.products.createIndex({ tags: 1 }) # <-- NUEVO √çNDICE PARA TAGS
  db.tags.createIndex({ name: 1 }, { unique: true }) # <-- NUEVO √çNDICE PARA TAGS
  db.customers.createIndex({ email: 1 }, { unique: true })
  db.customers.createIndex({ userId: 1 }, { unique: true, sparse: true })
  db.users.createIndex({ email: 1 }, { unique: true })
  db.payments.createIndex({ externalReference: 1 }, { unique: true })
  db.payments.createIndex({ preferenceId: 1 }, { unique: true })
  db.addresses.createIndex({ customerId: 1 })
  db.categories.createIndex({ name: 1 }, { unique: true }) // Asumiendo unicidad
  db.units.createIndex({ name: 1 }, { unique: true }) // Asumiendo unicidad
  db.cities.createIndex({ name: 1 }, { unique: true }) // Asumiendo unicidad
  db.neighborhoods.createIndex({ name: 1, city: 1 }, { unique: true }) // √çndice compuesto
  db.coupons.createIndex({ code: 1 }, { unique: true }) // Asumiendo unicidad
  // Revisa otros √≠ndices que puedas necesitar
  ```

## ‚ñ∂Ô∏è Ejecutar la Aplicaci√≥n

* **Modo Desarrollo:**

  ```
  npm run dev
  ```
* **Compilar y Ejecutar en Producci√≥n:**

  ```
  npm run build
  npm start
  ```

**La API estar√° en** **http://localhost:PORT**.

## üß™ Ejecutar Tests (Pendiente)

```
npm test
```

**üåê API Endpoints Principales**

## üí° Decisiones Arquitect√≥nicas y Destacados

* **TypeScript, Arquitectura en Capas, Inyecci√≥n de Dependencias, DTOs, Mappers.**
* **Logging Detallado (Winston), Rate Limiting.**
* **Autenticaci√≥n JWT y autorizaci√≥n por Roles.**
* **B√∫squeda/Filtrado eficiente con MongoDB nativo (incluyendo filtro por** **tags**).
* **Gesti√≥n de Direcciones de Env√≠o separada.**
* **Snapshot de Direcci√≥n en Pedidos.**
* **Panel de Administraci√≥n API (**/api/admin**).**
* **Chatbot RAG con Langchain y Transformers.js.**
* **Integraciones: Mercado Pago, Cloudinary, Nodemailer.**

## üöß Mejoras Futuras / TODO

**Prioridad Alta (Funcionalidad Core / Calidad):**

* **Pruebas:** **Unitarias, Integraci√≥n, E2E.**
* **L√≥gica de Env√≠o y C√°lculo de Costos.**
* **Gesti√≥n de Variaciones de Producto.**
* **Gesti√≥n de Inventario Robusta.**
* **Roles y Permisos (RBAC):** **Implementar** **AuthMiddleware.checkRole** **efectivamente.**
* **Documentaci√≥n de API (Swagger/OpenAPI).**

**Prioridad Media (UX / Operaci√≥n):**

* **Panel de Administraci√≥n Frontend.**
* **Sistema de Rese√±as y Calificaciones.**
* **Flujo de Pedidos Detallado (Estados, Tracking).**
* **Optimizaci√≥n de B√∫squeda (Facetas, Autocomplete).**
* **Gesti√≥n de Devoluciones (RMA).**

**Prioridad Baja (Competitividad / Extras):**

* **Wishlist.**
* **Recomendaciones de Productos.**
* **Promociones Avanzadas.**
* **Notificaciones Adicionales (Email/Push).**
* **Refinar L√≥gica del Chatbot.**
* **Integraci√≥n con Anal√≠tica.**
* **Soporte Multi-idioma/Multi-moneda.**
* **Optimizaci√≥n SEO (si aplica al backend).**
* **Scripts de Despliegue (Docker).**
* **A√±adir m√°s proveedores de pago.**

## ü§ù Contribuciones

**Las contribuciones son bienvenidas. Por favor, abre un issue o un Pull Request.**

## üìÑ Licencia

**(Opcional: Especifica tu licencia, ej. MIT)**

## üåê API Endpoints Detallados

---

### Endpoints Generales

**Salud y Estado del Servidor:**

* **GET /**: Endpoint ra√≠z que confirma que la API est√° funcionando. **(üîì P√∫blico - Sin JWT)**

  **Respuesta JSON:**

  ```json
  {
    "message": "API E-commerce V1 - Running OK"
  }
  ```

* **GET /ping**: Endpoint de health check simple para monitoreo. **(üîì P√∫blico - Sin JWT)**

  **Respuesta de texto:**

  ```
  pong
  ```

---

### Autenticaci√≥n (**/api/auth**)

* **POST /register**: Registra un nuevo usuario en el sistema y crea un perfil de cliente b√°sico asociado.
* **POST /login**: Autentica a un usuario existente usando email y contrase√±a, devuelve un token JWT. (Protegido por Rate Limit).
* **GET /**: Verifica un token JWT v√°lido y devuelve los datos del usuario autenticado asociado a ese token. (Requiere JWT).
* **GET /all**: (Admin) Obtiene una lista de todos los usuarios registrados en el sistema. (Requiere JWT + Admin Role).
* **PUT /:id**: (Admin) Actualiza la informaci√≥n de un usuario espec√≠fico (ej: nombre, roles). (Requiere JWT + Admin Role).
* **DELETE /:id**: (Admin) Elimina un usuario espec√≠fico del sistema. (Requiere JWT + Admin Role).
* **POST /forgot-password**: Inicia el proceso de recuperaci√≥n de contrase√±a para un email dado. Env√≠a un email con un enlace de reseteo si el usuario existe. (Protegido por Rate Limit).
* **POST /reset-password**: Permite a un usuario establecer una nueva contrase√±a usando un token v√°lido recibido por email. (Protegido por Rate Limit).

---

### Productos (**/api/products**)

**Endpoints P√∫blicos (No requieren autenticaci√≥n):**

* **GET /search**: Realiza b√∫squedas de productos por palabra clave (nombre/descripci√≥n) y permite filtrar por categor√≠as, **etiquetas (tags)**, rango de precios, y ordenar los resultados. Devuelve resultados paginados y el conteo total. **(üîì P√∫blico - Sin JWT)**

  * **Query Params:** **q**, **categories** **(string CSV),** **minPrice**, **maxPrice**, **tags** **(string CSV, ej:** **popular,oferta**)**,** **sortBy** **(**price**,** **createdAt**, **name**, **relevance**), **sortOrder** **(**asc**,** **desc**), **page**, **limit**.
* **GET /by-category/:categoryId**: Lista productos pertenecientes a una categor√≠a espec√≠fica, con paginaci√≥n. **(üîì P√∫blico - Sin JWT)**
* **GET /**: Lista todos los productos activos, con paginaci√≥n. **(üîì P√∫blico - Sin JWT)**
* **GET /:id**: Obtiene los detalles de un producto espec√≠fico por su ID. **(üîì P√∫blico - Sin JWT)**

**Endpoints de Administraci√≥n:**

* **POST /**: Crea un nuevo producto. Permite subir una imagen (campo **image** **en** **multipart/form-data**) y asignar **etiquetas (campo** **tags** **como string CSV o array en** **form-data**)**. **(üîí Requiere JWT + Admin Role)**

  **Estructura JSON requerida (form-data):**

  ```json
  {
    "name": "Smartphone Galaxy S24",
    "description": "√öltimo modelo con c√°mara de 108MP y 5G",
    "price": 899.99,
    "stock": 50,
    "categoryId": "category_id_here",
    "unitId": "unit_id_here",
    "tags": "popular,nuevo,5g", // O como array: ["popular", "nuevo", "5g"]
    "taxRate": 0.21,
    "isActive": true,
    "image": "archivo_imagen.jpg" // Campo multipart/form-data
  }
  ```
* **PUT /:id**: Actualiza un producto existente. Permite subir/reemplazar una imagen (campo **image** **en** **multipart/form-data**) y modificar **etiquetas (campo** **tags** **como string CSV o array en** **form-data**, enviar vac√≠o o null para borrar)**. **(üîí Requiere JWT + Admin Role)**
* **DELETE /:id**: Elimina un producto (y su imagen asociada si existe). **(üîí Requiere JWT + Admin Role)**

---

### Categor√≠as (**/api/categories**)

> ‚ö†Ô∏è **ADVERTENCIA DE SEGURIDAD**: Todos los endpoints de categor√≠as son actualmente p√∫blicos. Se recomienda proteger POST, PUT y DELETE con autenticaci√≥n de administrador.

**Todos los Endpoints (Actualmente p√∫blicos - Sin autenticaci√≥n):**

* **GET /**: Lista todas las categor√≠as (paginado). **(üîì P√∫blico - Sin JWT)**
* **GET /:id**: Obtiene una categor√≠a por su ID. **(üîì P√∫blico - Sin JWT)**
* **POST /**: Crea una nueva categor√≠a. **(üîì P√∫blico - Sin JWT)** ‚ö†Ô∏è *Deber√≠a requerir Admin*

  **Estructura JSON requerida:**

  ```json
  {
    "name": "Tecnolog√≠a",
    "description": "Productos relacionados con tecnolog√≠a y gadgets",
    "isActive": true
  }
  ```

  **Respuesta JSON:**

  ```json
  {
    "id": 1,
    "name": "Tecnolog√≠a",
    "description": "Productos relacionados con tecnolog√≠a y gadgets",
    "isActive": true
  }
  ```
* **PUT /:id**: Actualiza una categor√≠a existente. **(üîì P√∫blico - Sin JWT)** ‚ö†Ô∏è *Deber√≠a requerir Admin*
* **DELETE /:id**: Elimina una categor√≠a. **(üîì P√∫blico - Sin JWT)** ‚ö†Ô∏è *Deber√≠a requerir Admin*

---

### Tags (Etiquetas) (**/api/tags**)

**Endpoints P√∫blicos (No requieren autenticaci√≥n):**

* **GET /**: Lista todas las etiquetas activas (paginado). **(üîì P√∫blico - Sin JWT)**

  **Respuesta JSON:**

  ```json
  {
    "tags": [
      {
        "id": "tag_id_string",
        "name": "popular",
        "description": "Productos populares entre los usuarios",
        "isActive": true,
        "createdAt": "2024-01-15T10:30:00.000Z",
        "updatedAt": "2024-01-15T10:30:00.000Z"
      }
    ],
    "pagination": {
      "page": 1,
      "limit": 10,
      "total": 25,
      "totalPages": 3
    }
  }
  ```

**Endpoints de Administraci√≥n (**/api/admin/tags**):**

* **POST /**: Crea una nueva etiqueta. **(üîí Requiere JWT + Admin Role)**

  **Estructura JSON requerida:**

  ```json
  {
    "name": "oferta",
    "description": "Productos en oferta especial",
    "isActive": true
  }
  ```

  **Respuesta JSON:**

  ```json
  {
    "id": "generated_string_id",
    "name": "oferta",
    "description": "Productos en oferta especial",
    "isActive": true,
    "createdAt": "2024-01-15T10:30:00.000Z",
    "updatedAt": "2024-01-15T10:30:00.000Z"
  }
  ```
* **PUT /:id**: Actualiza una etiqueta existente. **(üîí Requiere JWT + Admin Role)**
* **DELETE /:id**: Elimina una etiqueta. **(üîí Requiere JWT + Admin Role)**

---

### Unidades (**/api/units**)

> ‚ö†Ô∏è **ADVERTENCIA DE SEGURIDAD**: Todos los endpoints de unidades son actualmente p√∫blicos. Se recomienda proteger POST, PUT y DELETE con autenticaci√≥n de administrador.

**Todos los Endpoints (Actualmente p√∫blicos - Sin autenticaci√≥n):**

* **GET /**: Lista todas las unidades de medida (paginado). **(üîì P√∫blico - Sin JWT)**
* **GET /:id**: Obtiene una unidad por su ID. **(üîì P√∫blico - Sin JWT)**
* **POST /**: Crea una nueva unidad. **(üîì P√∫blico - Sin JWT)** ‚ö†Ô∏è *Deber√≠a requerir Admin*

  **Estructura JSON requerida:**

  ```json
  {
    "name": "Kilogramo",
    "description": "Unidad de masa del sistema internacional",
    "isActive": true
  }
  ```

  **Respuesta JSON:**

  ```json
  {
    "id": 1,
    "name": "Kilogramo",
    "description": "Unidad de masa del sistema internacional",
    "isActive": true
  }
  ```
* **PUT /:id**: Actualiza una unidad existente. **(üîì P√∫blico - Sin JWT)** ‚ö†Ô∏è *Deber√≠a requerir Admin*
* **DELETE /:id**: Elimina una unidad. **(üîì P√∫blico - Sin JWT)** ‚ö†Ô∏è *Deber√≠a requerir Admin*

---

### Estados de Pedido (**/api/order-statuses**)

**Endpoints P√∫blicos (No requieren autenticaci√≥n):**

* **GET /active**: Lista todos los estados de pedido activos (ordenados por order). **(üîì P√∫blico - Sin JWT)**
* **GET /default**: Obtiene el estado de pedido por defecto del sistema. **(üîì P√∫blico - Sin JWT)**
* **GET /code/:code**: Busca un estado de pedido espec√≠fico por su c√≥digo (ej: "PENDING", "CONFIRMED"). **(üîì P√∫blico - Sin JWT)**

**Endpoints de Administraci√≥n:**

* **GET /**: Lista todos los estados de pedido (activos e inactivos) con paginaci√≥n. **(üîí Requiere JWT + Admin Role)**
* **POST /**: Crea un nuevo estado de pedido. **(üîí Requiere JWT + Admin Role)**

  **Estructura JSON requerida:**

  ```json
  {
    "code": "PREPARING",
    "name": "En Preparaci√≥n", 
    "description": "El pedido est√° siendo preparado para env√≠o",
    "color": "#FF9800",
    "order": 3,
    "isActive": true,
    "isDefault": false,
    "canTransitionTo": ["shipped_status_id", "cancelled_status_id"]
  }
  ```

  **Respuesta JSON:**

  ```json
  {
    "id": "generated_string_id",
    "code": "PREPARING",
    "name": "En Preparaci√≥n",
    "description": "El pedido est√° siendo preparado para env√≠o",
    "color": "#FF9800",
    "order": 3,
    "isActive": true,
    "isDefault": false,
    "canTransitionTo": ["shipped_status_id", "cancelled_status_id"],
    "createdAt": "2024-01-15T10:30:00.000Z",
    "updatedAt": "2024-01-15T10:30:00.000Z"
  }
  ```
* **PUT /:id**: Actualiza un estado de pedido existente. **(üîí Requiere JWT + Admin Role)**

  **Estructura JSON requerida:**

  ```json
  {
    "code": "PREPARING_UPDATED",
    "name": "En Preparaci√≥n Actualizado",
    "description": "Descripci√≥n actualizada del estado",
    "color": "#FF9800",
    "order": 3,
    "isActive": true,
    "isDefault": false,
    "canTransitionTo": ["shipped_status_id", "cancelled_status_id"]
  }
  ```

  **Alternativamente, puedes usar c√≥digos de estado en lugar de IDs para las transiciones:**

  ```json
  {
    "code": "PREPARING_UPDATED",
    "allowedTransitions": ["SHIPPED", "CANCELLED"]
  }
  ```

  **Notas importantes:**

  - El campo `code` se convierte autom√°ticamente a may√∫sculas.
  - Puedes usar tanto `canTransitionTo` (con ObjectIds) como `allowedTransitions` (con c√≥digos de estado).
  - Los c√≥digos de estado en `allowedTransitions` se convierten autom√°ticamente a ObjectIds.
  - Todos los campos son opcionales; solo se actualizar√°n los campos proporcionados.
  - Si se proporciona un c√≥digo duplicado, se retornar√° un error 400.
* **DELETE /:id**: Elimina un estado de pedido (solo si no est√° siendo usado por ning√∫n pedido). **(üîí Requiere JWT + Admin Role)**
* **POST /validate-transition**: Valida si una transici√≥n de estado es permitida. **(üîí Requiere JWT + Admin Role)**

  **Estructura JSON requerida:**

  ```json
  {
    "fromStatusId": "current_status_id",
    "toStatusId": "target_status_id"
  }
  ```

---

### Ciudades (**/api/cities**)

**Endpoints P√∫blicos (No requieren autenticaci√≥n):**

* **GET /**: Lista todas las ciudades (paginado). **(üîì P√∫blico - Sin JWT)**
* **GET /:id**: Obtiene una ciudad por su ID. **(üîì P√∫blico - Sin JWT)**
* **GET /by-name/:name**: Busca una ciudad por su nombre exacto. **(üîì P√∫blico - Sin JWT)**

**Endpoints de Administraci√≥n:**

* **POST /**: Crea una nueva ciudad. **(üîí Requiere JWT + Admin Role)**

  **Estructura JSON requerida:**

  ```json
  {
    "name": "Buenos Aires",
    "description": "Capital de Argentina",
    "isActive": true
  }
  ```

  **Respuesta JSON:**

  ```json
  {
    "id": "generated_string_id",
    "name": "Buenos Aires",
    "description": "Capital de Argentina",
    "isActive": true
  }
  ```
* **PUT /:id**: Actualiza una ciudad existente. **(üîí Requiere JWT + Admin Role)**
* **DELETE /:id**: Elimina una ciudad. **(üîí Requiere JWT + Admin Role)**

---

### Barrios (**/api/neighborhoods**)

**Endpoints P√∫blicos (No requieren autenticaci√≥n):**

* **GET /**: Lista todos los barrios (paginado). **(üîì P√∫blico - Sin JWT)**
* **GET /:id**: Obtiene un barrio por su ID. **(üîì P√∫blico - Sin JWT)**
* **GET /by-city/:cityId**: Lista barrios pertenecientes a una ciudad espec√≠fica (paginado). **(üîì P√∫blico - Sin JWT)**

**Endpoints de Administraci√≥n:**

* **POST /**: Crea un nuevo barrio, asoci√°ndolo a una ciudad. **(üîí Requiere JWT + Admin Role)**

  **Estructura JSON requerida:**

  ```json
  {
    "name": "Palermo",
    "description": "Barrio tradicional de Buenos Aires",
    "cityId": "city_string_id",
    "isActive": true
  }
  ```
* **PUT /:id**: Actualiza un barrio existente. **(üîí Requiere JWT + Admin Role)**
* **DELETE /:id**: Elimina un barrio. **(üîí Requiere JWT + Admin Role)**

---

### Pedidos/Ventas (**/api/sales**)

**Endpoints para Clientes (Requieren autenticaci√≥n):**

* **POST /**: Crea un nuevo pedido (venta) para el usuario autenticado. **(üîí Requiere JWT)**

  **Estructura JSON requerida:**

  ```json
  {
    "items": [
      {
        "productId": "product_id_string",
        "quantity": 2,
        "unitPrice": 29.99,
        "taxRate": 0.21
      }
    ],
    "address": {
      "street": "Av. Corrientes 1234",
      "city": "Buenos Aires",
      "neighborhood": "Centro",
      "zipCode": "C1043AAZ",
      "country": "Argentina",
      "additionalInfo": "Portero el√©ctrico"
    },
    "couponCode": "DESCUENTO10", // Opcional
    "notes": "Entregar despu√©s de las 18hs" // Opcional
  }
  ```

  **Respuesta JSON:**

  ```json
  {
    "id": "generated_order_id",
    "orderNumber": "ORD-2024-001234",
    "customer": {
      "id": "customer_id",
      "firstName": "Juan",
      "lastName": "P√©rez",
      "email": "juan.perez@email.com",
      "phone": "1123456789"
    },
    "items": [
      {
        "id": "item_id",
        "product": {
          "id": "product_id",
          "name": "Smartphone Galaxy S24",
          "description": "√öltimo modelo con c√°mara de 108MP",
          "imageUrl": "https://cloudinary.com/image.jpg"
        },
        "quantity": 2,
        "unitPrice": 29.99,
        "taxRate": 0.21,
        "subtotal": 59.98,
        "taxAmount": 12.60,
        "total": 72.58
      }
    ],
    "shippingAddress": {
      "street": "Av. Corrientes 1234",
      "city": "Buenos Aires",
      "neighborhood": "Centro",
      "zipCode": "C1043AAZ",
      "country": "Argentina",
      "additionalInfo": "Portero el√©ctrico"
    },
    "status": {
      "id": "status_id",
      "code": "PENDING",
      "name": "Pendiente",
      "color": "#FFC107"
    },
    "subtotal": 59.98,
    "taxAmount": 12.60,
    "discountAmount": 6.00,
    "total": 66.58,
    "coupon": {
      "id": "coupon_id",
      "code": "DESCUENTO10",
      "discountType": "PERCENTAGE",
      "discountValue": 10
    },
    "notes": "Entregar despu√©s de las 18hs",
    "createdAt": "2024-01-15T14:30:00.000Z",
    "updatedAt": "2024-01-15T14:30:00.000Z"
  }
  ```
* **GET /my-orders**: Lista todos los pedidos del usuario autenticado con paginaci√≥n. **(üîí Requiere JWT)**

  **Query Params:** **page** **(default: 1)**, **limit** **(default: 10)**

  **Respuesta JSON:**

  ```json
  {
    "orders": [
      {
        "id": "order_id",
        "orderNumber": "ORD-2024-001234",
        "status": {
          "id": "status_id",
          "code": "PENDING",
          "name": "Pendiente",
          "color": "#FFC107"
        },
        "itemsCount": 3,
        "total": 156.75,
        "createdAt": "2024-01-15T14:30:00.000Z"
      }
    ],
    "pagination": {
      "page": 1,
      "limit": 10,
      "total": 25,
      "totalPages": 3
    }
  }
  ```
* **GET /:id**: Obtiene los detalles completos de un pedido espec√≠fico (solo si pertenece al usuario autenticado). **(üîí Requiere JWT)**

  **Respuesta JSON:** *(Mismo formato que la respuesta de POST /)*
* **PUT /:id/status**: Actualiza el estado de un pedido espec√≠fico (solo si pertenece al usuario autenticado y la transici√≥n es v√°lida). **(üîí Requiere JWT)**

  **Estructura JSON requerida:**

  ```json
  {
    "statusId": "new_status_id"
  }
  ```

  **Respuesta JSON:**

  ```json
  {
    "id": "order_id",
    "orderNumber": "ORD-2024-001234",
    "status": {
      "id": "new_status_id",
      "code": "CONFIRMED",
      "name": "Confirmado",
      "color": "#4CAF50"
    },
    "updatedAt": "2024-01-15T15:45:00.000Z"
  }
  ```

---

### Administraci√≥n de Pedidos (**/api/admin/orders**)

**Todos los endpoints requieren JWT + Admin Role:**

* **GET /**: Lista todos los pedidos del sistema con filtros y paginaci√≥n. **(üîí Requiere JWT + Admin Role)**

  **Query Params:**

  - **page** **(default: 1)**, **limit** **(default: 10)**
  - **status** **(filtrar por c√≥digo de estado, ej: PENDING, CONFIRMED)**
  - **customerId** **(filtrar por ID del cliente)**
  - **startDate**, **endDate** **(filtrar por rango de fechas, formato: YYYY-MM-DD)**
  - **minAmount**, **maxAmount** **(filtrar por rango de montos)**

  **Ejemplo:** **GET /api/admin/orders?status=PENDING&page=1&limit=10&startDate=2024-01-01&endDate=2024-01-31**

  **Respuesta JSON:**

  ```json
  {
    "orders": [
      {
        "id": "order_id",
        "orderNumber": "ORD-2024-001234",
        "customer": {
          "id": "customer_id",
          "firstName": "Juan",
          "lastName": "P√©rez",
          "email": "juan.perez@email.com",
          "phone": "1123456789"
        },
        "status": {
          "id": "status_id",
          "code": "PENDING",
          "name": "Pendiente",
          "color": "#FFC107"
        },
        "itemsCount": 3,
        "subtotal": 149.97,
        "taxAmount": 31.49,
        "discountAmount": 15.00,
        "total": 166.46,
        "shippingAddress": {
          "street": "Av. Corrientes 1234",
          "city": "Buenos Aires",
          "neighborhood": "Centro",
          "zipCode": "C1043AAZ",
          "country": "Argentina"
        },
        "createdAt": "2024-01-15T14:30:00.000Z",
        "updatedAt": "2024-01-15T14:30:00.000Z"
      }
    ],
    "pagination": {
      "page": 1,
      "limit": 10,
      "total": 156,
      "totalPages": 16
    }
  }
  ```
* **GET /:id**: Obtiene los detalles completos de cualquier pedido por su ID. **(üîí Requiere JWT + Admin Role)**

  **Respuesta JSON:** *(Mismo formato detallado que POST /api/sales/)*
* **PUT /:id/status**: Actualiza el estado de cualquier pedido (sin restricciones de propiedad). **(üîí Requiere JWT + Admin Role)**

  **Estructura JSON requerida:**

  ```json
  {
    "statusId": "new_status_id",
    "adminNotes": "Motivo del cambio de estado" // Opcional
  }
  ```

  **Respuesta JSON:**

  ```json
  {
    "id": "order_id",
    "orderNumber": "ORD-2024-001234",
    "status": {
      "id": "new_status_id",
      "code": "SHIPPED",
      "name": "Enviado",
      "color": "#2196F3"
    },
    "adminNotes": "Motivo del cambio de estado",
    "updatedAt": "2024-01-15T16:20:00.000Z"
  }
  ```
* **GET /by-customer/:customerId**: Lista todos los pedidos de un cliente espec√≠fico. **(üîí Requiere JWT + Admin Role)**

  **Query Params:** **page** **(default: 1)**, **limit** **(default: 10)**

  **Respuesta JSON:** *(Mismo formato que GET / pero filtrado por cliente)*
* **GET /by-date-range**: Lista pedidos en un rango de fechas espec√≠fico. **(üîí Requiere JWT + Admin Role)**

  **Query Params:**

  - **startDate** **(requerido, formato: YYYY-MM-DD)**
  - **endDate** **(requerido, formato: YYYY-MM-DD)**
  - **page** **(default: 1)**, **limit** **(default: 10)**

  **Ejemplo:** **GET /api/admin/orders/by-date-range?startDate=2024-01-01&endDate=2024-01-31&page=1&limit=20**

  **Respuesta JSON:** *(Mismo formato que GET / pero filtrado por fechas)*
* **DELETE /:id**: Elimina un pedido espec√≠fico del sistema (‚ö†Ô∏è Acci√≥n irreversible). **(üîí Requiere JWT + Admin Role)**

  **Respuesta JSON:**

  ```json
  {
    "message": "Pedido eliminado exitosamente",
    "deletedOrderId": "order_id",
    "deletedOrderNumber": "ORD-2024-001234"
  }
  ```

---

### Carrito de Compras (**/api/cart**)

**Todos los endpoints requieren autenticaci√≥n JWT:**

* **GET /**: Obtiene el carrito del usuario autenticado. **(üîí Requiere JWT)**
  
  **Respuesta JSON:**
  ```json
  {
    "id": "cart_id",
    "customerId": "customer_id", 
    "items": [
      {
        "id": "item_id",
        "product": {
          "id": "product_id",
          "name": "Smartphone Galaxy S24",
          "description": "√öltimo modelo con c√°mara de 108MP",
          "price": 899.99,
          "imageUrl": "https://cloudinary.com/image.jpg"
        },
        "quantity": 2,
        "unitPrice": 899.99,
        "taxRate": 0.21,
        "subtotal": 1799.98,
        "taxAmount": 377.99,
        "total": 2177.97
      }
    ],
    "itemsCount": 2,
    "subtotal": 1799.98,
    "taxAmount": 377.99,
    "total": 2177.97,
    "updatedAt": "2024-01-15T14:30:00.000Z"
  }
  ```

* **POST /items**: A√±ade un producto al carrito o actualiza la cantidad si ya existe. **(üîí Requiere JWT)**
  
  **Estructura JSON requerida:**
  ```json
  {
    "productId": "product_id_string",
    "quantity": 2
  }
  ```
  
  **Respuesta JSON:** *(Mismo formato que GET /)*

* **PUT /items/:productId**: Actualiza la cantidad de un producto espec√≠fico en el carrito. **(üîí Requiere JWT)**
  
  **Estructura JSON requerida:**
  ```json
  {
    "quantity": 3
  }
  ```
  
  **Respuesta JSON:** *(Mismo formato que GET /)*

* **DELETE /items/:productId**: Elimina un producto espec√≠fico del carrito. **(üîí Requiere JWT)**
  
  **Respuesta JSON:** *(Mismo formato que GET / sin el producto eliminado)*

* **DELETE /**: Vac√≠a completamente el carrito del usuario. **(üîí Requiere JWT)**
  
  **Respuesta JSON:**
  ```json
  {
    "message": "Carrito vaciado exitosamente",
    "cart": {
      "id": "cart_id",
      "customerId": "customer_id",
      "items": [],
      "itemsCount": 0,
      "subtotal": 0,
      "taxAmount": 0,
      "total": 0
    }
  }
  ```

---

### Clientes (**/api/customers**)

**Endpoints P√∫blicos (No requieren autenticaci√≥n):**

* **GET /**: Lista todos los clientes (paginado). **(üîì P√∫blico - Sin JWT)**
* **GET /:id**: Obtiene un cliente por su ID. **(üîì P√∫blico - Sin JWT)**
* **GET /by-email/:email**: Busca un cliente por su email. **(üîì P√∫blico - Sin JWT)**
* **GET /by-neighborhood/:neighborhoodId**: Lista clientes de un barrio espec√≠fico. **(üîì P√∫blico - Sin JWT)**

**Endpoints de Administraci√≥n:**

* **POST /**: Crea un nuevo cliente. **(üîí Requiere JWT + Admin Role)**
  
  **Estructura JSON requerida:**
  ```json
  {
    "firstName": "Juan",
    "lastName": "P√©rez",
    "email": "juan.perez@email.com",
    "phone": "1123456789",
    "documentType": "DNI",
    "documentNumber": "12345678",
    "neighborhoodId": "neighborhood_id_string",
    "isActive": true
  }
  ```
  
  **Respuesta JSON:**
  ```json
  {
    "id": "generated_customer_id",
    "firstName": "Juan",
    "lastName": "P√©rez",
    "email": "juan.perez@email.com",
    "phone": "1123456789",
    "documentType": "DNI", 
    "documentNumber": "12345678",
    "neighborhood": {
      "id": "neighborhood_id",
      "name": "Centro",
      "city": {
        "id": "city_id",
        "name": "Buenos Aires"
      }
    },
    "isActive": true,
    "createdAt": "2024-01-15T10:30:00.000Z",
    "updatedAt": "2024-01-15T10:30:00.000Z"
  }
  ```

* **PUT /:id**: Actualiza un cliente existente. **(üîí Requiere JWT + Admin Role)**
* **DELETE /:id**: Elimina un cliente. **(üîí Requiere JWT + Admin Role)**

---

### Direcciones (**/api/addresses**)

**Todos los endpoints requieren autenticaci√≥n JWT:**

* **GET /**: Lista todas las direcciones del usuario autenticado. **(üîí Requiere JWT)**
  
  **Respuesta JSON:**
  ```json
  {
    "addresses": [
      {
        "id": "address_id",
        "street": "Av. Corrientes 1234",
        "neighborhood": {
          "id": "neighborhood_id",
          "name": "Centro",
          "city": {
            "id": "city_id", 
            "name": "Buenos Aires"
          }
        },
        "zipCode": "C1043AAZ",
        "country": "Argentina",
        "additionalInfo": "Portero el√©ctrico",
        "isDefault": true,
        "createdAt": "2024-01-15T10:30:00.000Z",
        "updatedAt": "2024-01-15T10:30:00.000Z"
      }
    ]
  }
  ```

* **POST /**: Crea una nueva direcci√≥n para el usuario autenticado. **(üîí Requiere JWT)**
  
  **Estructura JSON requerida:**
  ```json
  {
    "street": "Av. Corrientes 1234",
    "neighborhoodId": "neighborhood_id_string",
    "zipCode": "C1043AAZ", 
    "country": "Argentina",
    "additionalInfo": "Portero el√©ctrico",
    "isDefault": false
  }
  ```
  
  **Respuesta JSON:** *(Misma estructura que el objeto en GET /)*

* **PUT /:id**: Actualiza una direcci√≥n espec√≠fica del usuario autenticado. **(üîí Requiere JWT)**
  
  **Estructura JSON requerida:** *(Mismo formato que POST /)*
  
  **Respuesta JSON:** *(Misma estructura que el objeto en GET /)*

* **DELETE /:id**: Elimina una direcci√≥n espec√≠fica del usuario autenticado. **(üîí Requiere JWT)**
  
  **Respuesta JSON:**
  ```json
  {
    "message": "Direcci√≥n eliminada exitosamente",
    "deletedAddressId": "address_id"
  }
  ```

* **PATCH /:id/default**: Marca una direcci√≥n como predeterminada para el usuario autenticado. **(üîí Requiere JWT)**
  
  **Respuesta JSON:** *(Misma estructura que el objeto en GET / con isDefault: true)*

---

### Cupones (**/api/coupons**)

**Todos los endpoints requieren autenticaci√≥n JWT:**

* **GET /**: Lista todos los cupones (paginado). **(üîí Requiere JWT)**
  
  **Query Params:** **page** **(default: 1)**, **limit** **(default: 10)**
  
  **Respuesta JSON:**
  ```json
  {
    "coupons": [
      {
        "id": "coupon_id",
        "code": "DESCUENTO10",
        "name": "Descuento 10%",
        "description": "Descuento del 10% en toda la tienda",
        "discountType": "PERCENTAGE",
        "discountValue": 10,
        "minimumPurchase": 100,
        "maxUses": 100,
        "usedCount": 25,
        "validFrom": "2024-01-01T00:00:00.000Z",
        "validUntil": "2024-12-31T23:59:59.000Z",
        "isActive": true,
        "createdAt": "2024-01-15T10:30:00.000Z",
        "updatedAt": "2024-01-15T10:30:00.000Z"
      }
    ],
    "pagination": {
      "page": 1,
      "limit": 10,
      "total": 15,
      "totalPages": 2
    }
  }
  ```

* **GET /:id**: Obtiene un cup√≥n espec√≠fico por su ID. **(üîí Requiere JWT)**
  
  **Respuesta JSON:** *(Misma estructura que el objeto en GET /)*

* **POST /**: Crea un nuevo cup√≥n. **(üîí Requiere JWT)**
  
  **Estructura JSON requerida:**
  ```json
  {
    "code": "DESCUENTO15",
    "name": "Descuento 15%",
    "description": "Descuento del 15% para clientes VIP",
    "discountType": "PERCENTAGE",
    "discountValue": 15,
    "minimumPurchase": 200,
    "maxUses": 50,
    "validFrom": "2024-01-01T00:00:00.000Z",
    "validUntil": "2024-12-31T23:59:59.000Z",
    "isActive": true
  }
  ```
  
  **Respuesta JSON:** *(Misma estructura que el objeto en GET /)*

* **PUT /:id**: Actualiza un cup√≥n existente. **(üîí Requiere JWT)**
  
  **Estructura JSON requerida:** *(Mismo formato que POST /)*
  
  **Respuesta JSON:** *(Misma estructura que el objeto en GET /)*

* **DELETE /:id**: Elimina un cup√≥n o lo desactiva. **(üîí Requiere JWT)**
  
  **Respuesta JSON:**
  ```json
  {
    "message": "Cup√≥n eliminado exitosamente",
    "deletedCouponId": "coupon_id"
  }
  ```

---

### Pagos (**/api/payments**)

**Endpoints P√∫blicos (Webhooks y Callbacks):**

* **POST /webhook**: Procesa webhooks de Mercado Pago para actualizar estados de pago. **(üîì P√∫blico - Sin JWT)**
* **GET /success**: Callback de √©xito de Mercado Pago, redirige al frontend. **(üîì P√∫blico - Sin JWT)**
* **GET /failure**: Callback de fallo de Mercado Pago, redirige al frontend. **(üîì P√∫blico - Sin JWT)**
* **GET /pending**: Callback de pago pendiente de Mercado Pago, redirige al frontend. **(üîì P√∫blico - Sin JWT)**

**Endpoints Protegidos (Gesti√≥n de Pagos):**

* **POST /sale/:saleId**: Crea una preferencia de pago para un pedido espec√≠fico. **(üîí Requiere JWT)**
  
  **Respuesta JSON:**
  ```json
  {
    "id": "payment_id",
    "saleId": "sale_id",
    "preferenceId": "MP-preference-id",
    "externalReference": "unique-reference",
    "paymentUrl": "https://www.mercadopago.com.ar/checkout/v1/redirect?pref_id=preference_id",
    "status": "PENDING",
    "amount": 199.99,
    "createdAt": "2024-01-15T14:30:00.000Z"
  }
  ```

* **GET /:id**: Obtiene los detalles de un pago espec√≠fico. **(üîí Requiere JWT)**
* **GET /by-sale/:saleId**: Lista todos los pagos de un pedido espec√≠fico. **(üîí Requiere JWT)**
* **GET /**: Lista todos los pagos (admin). **(üîí Requiere JWT)**
* **POST /verify**: Verifica manualmente el estado de un pago. **(üîí Requiere JWT)**
* **GET /preference/:preferenceId**: Verifica el estado de una preferencia de pago. **(üîí Requiere JWT)**
* **GET /mercadopago/payments**: Lista pagos realizados en Mercado Pago del √∫ltimo a√±o. **(üîí Requiere JWT)**
* **GET /mercadopago/charges**: Lista cobros realizados en Mercado Pago del √∫ltimo a√±o. **(üîí Requiere JWT)**
* **POST /prueba/sale/:saleId**: M√©todo de prueba simplificado para crear pagos. **(üîí Requiere JWT)**

---

### Chatbot (**/api/chatbot**)

**Endpoints P√∫blicos:**

* **POST /query**: Env√≠a una consulta al chatbot y obtiene una respuesta. **(üîì P√∫blico - Sin JWT)**
  
  **Estructura JSON requerida:**
  ```json
  {
    "message": "¬øQu√© productos tienen en oferta?",
    "sessionId": "session_uuid_optional",
    "mode": "client"
  }
  ```
  
  **Respuesta JSON:**
  ```json
  {
    "response": "Tenemos varios productos en oferta como smartphones, laptops...",
    "sessionId": "session_uuid",
    "timestamp": "2024-01-15T14:30:00.000Z"
  }
  ```

* **GET /session/:sessionId**: Obtiene el historial de una sesi√≥n de chat. **(üîì P√∫blico - Sin JWT)**
* **POST /session**: Crea una nueva sesi√≥n de chat. **(üîì P√∫blico - Sin JWT)**

**Endpoints de Administraci√≥n:**

* **GET /sessions**: Lista todas las sesiones de chat (admin). **(üîí Requiere JWT + Admin Role)**
* **POST /generate-embeddings**: Regenera los embeddings del sistema. **(üîí Requiere JWT + Admin Role)**
* **POST /change-llm**: Cambia el modelo LLM utilizado. **(üîí Requiere JWT + Admin Role)**
* **GET /current-llm**: Obtiene el modelo LLM actual. **(üîí Requiere JWT + Admin Role)**
* **GET /validate-embeddings**: Valida los embeddings del sistema. **(üîí Requiere JWT + Admin Role)**

---

### Administraci√≥n de Productos (**/api/admin/products**)

**Todos los endpoints requieren JWT + Admin Role:**

* **GET /**: Lista todos los productos para administraci√≥n (incluyendo inactivos). **(üîí Requiere JWT + Admin Role)**
* **GET /search**: B√∫squeda avanzada de productos para admin. **(üîí Requiere JWT + Admin Role)**
* **GET /:id**: Obtiene un producto espec√≠fico para administraci√≥n. **(üîí Requiere JWT + Admin Role)**
* **POST /**: Crea un nuevo producto con imagen requerida. **(üîí Requiere JWT + Admin Role)**
  
  **Estructura multipart/form-data requerida:**
  ```
  name: "Smartphone Galaxy S24"
  description: "√öltimo modelo con c√°mara de 108MP y 5G"
  price: 899.99
  stock: 50
  categoryId: "category_id_here"
  unitId: "unit_id_here"
  tags: "popular,nuevo,5g"
  taxRate: 0.21
  isActive: true
  image: [archivo de imagen requerido]
  ```

* **PUT /:id**: Actualiza un producto existente con imagen opcional. **(üîí Requiere JWT + Admin Role)**
* **DELETE /:id**: Elimina un producto y su imagen asociada. **(üîí Requiere JWT + Admin Role)**
* **GET /by-category/:categoryId**: Lista productos por categor√≠a para admin. **(üîí Requiere JWT + Admin Role)**

---

### Administraci√≥n de Categor√≠as (**/api/admin/categories**)

**Todos los endpoints requieren JWT + Admin Role:**

* **GET /**: Lista todas las categor√≠as para administraci√≥n. **(üîí Requiere JWT + Admin Role)**
* **GET /:id**: Obtiene una categor√≠a espec√≠fica. **(üîí Requiere JWT + Admin Role)**
* **POST /**: Crea una nueva categor√≠a. **(üîí Requiere JWT + Admin Role)**
* **PUT /:id**: Actualiza una categor√≠a existente. **(üîí Requiere JWT + Admin Role)**
* **DELETE /:id**: Elimina una categor√≠a. **(üîí Requiere JWT + Admin Role)**

---

### Administraci√≥n de Unidades (**/api/admin/units**)

**Todos los endpoints requieren JWT + Admin Role:**

* **GET /**: Lista todas las unidades para administraci√≥n. **(üîí Requiere JWT + Admin Role)**
* **GET /:id**: Obtiene una unidad espec√≠fica. **(üîí Requiere JWT + Admin Role)**
* **POST /**: Crea una nueva unidad. **(üîí Requiere JWT + Admin Role)**
* **PUT /:id**: Actualiza una unidad existente. **(üîí Requiere JWT + Admin Role)**
* **DELETE /:id**: Elimina una unidad. **(üîí Requiere JWT + Admin Role)**

---

### Administraci√≥n de Clientes (**/api/admin/customers**)

**Todos los endpoints requieren JWT + Admin Role:**

* **GET /**: Lista todos los clientes para administraci√≥n. **(üîí Requiere JWT + Admin Role)**
* **GET /:id**: Obtiene un cliente espec√≠fico. **(üîí Requiere JWT + Admin Role)**
* **POST /**: Crea un nuevo cliente. **(üîí Requiere JWT + Admin Role)**
* **PUT /:id**: Actualiza un cliente existente. **(üîí Requiere JWT + Admin Role)**
* **DELETE /:id**: Elimina un cliente. **(üîí Requiere JWT + Admin Role)**

---

### Administraci√≥n de Usuarios (**/api/admin/users**)

**Todos los endpoints requieren JWT + Admin Role:**

* **GET /**: Lista todos los usuarios del sistema. **(üîí Requiere JWT + Admin Role)**
* **GET /:id**: Obtiene un usuario espec√≠fico. **(üîí Requiere JWT + Admin Role)**
* **POST /**: Crea un nuevo usuario. **(üîí Requiere JWT + Admin Role)**
* **PUT /:id**: Actualiza un usuario existente. **(üîí Requiere JWT + Admin Role)**
* **DELETE /:id**: Elimina un usuario. **(üîí Requiere JWT + Admin Role)**

---

### Administraci√≥n de Cupones (**/api/admin/coupons**)

**Todos los endpoints requieren JWT + Admin Role:**

* **GET /**: Lista todos los cupones para administraci√≥n. **(üîí Requiere JWT + Admin Role)**
* **GET /:id**: Obtiene un cup√≥n espec√≠fico. **(üîí Requiere JWT + Admin Role)**
* **POST /**: Crea un nuevo cup√≥n. **(üîí Requiere JWT + Admin Role)**
* **PUT /:id**: Actualiza un cup√≥n existente. **(üîí Requiere JWT + Admin Role)**
* **DELETE /:id**: Elimina un cup√≥n. **(üîí Requiere JWT + Admin Role)**

---

### Administraci√≥n de Ciudades (**/api/admin/cities**)

**Todos los endpoints requieren JWT + Admin Role:**

* **GET /**: Lista todas las ciudades para administraci√≥n. **(üîí Requiere JWT + Admin Role)**
* **GET /:id**: Obtiene una ciudad espec√≠fica. **(üîí Requiere JWT + Admin Role)**
* **POST /**: Crea una nueva ciudad. **(üîí Requiere JWT + Admin Role)**
* **PUT /:id**: Actualiza una ciudad existente. **(üîí Requiere JWT + Admin Role)**
* **DELETE /:id**: Elimina una ciudad. **(üîí Requiere JWT + Admin Role)**

---

### Administraci√≥n de Barrios (**/api/admin/neighborhoods**)

**Todos los endpoints requieren JWT + Admin Role:**

* **GET /**: Lista todos los barrios para administraci√≥n. **(üîí Requiere JWT + Admin Role)**
* **GET /:id**: Obtiene un barrio espec√≠fico. **(üîí Requiere JWT + Admin Role)**
* **POST /**: Crea un nuevo barrio. **(üîí Requiere JWT + Admin Role)**
* **PUT /:id**: Actualiza un barrio existente. **(üîí Requiere JWT + Admin Role)**
* **DELETE /:id**: Elimina un barrio. **(üîí Requiere JWT + Admin Role)**

---

## üîê Autenticaci√≥n y Autorizaci√≥n

### JWT Token
Todos los endpoints marcados con üîí requieren incluir el token JWT en el header:
```
Authorization: Bearer <token>
```

### Roles de Usuario
- **USER_ROLE**: Usuario est√°ndar registrado
- **ADMIN_ROLE**: Administrador con acceso completo

### Obtener Token
1. Registrarse: `POST /api/auth/register`
2. Iniciar sesi√≥n: `POST /api/auth/login`
3. Usar el token devuelto en el header `Authorization`

---

## ‚ö†Ô∏è Errores y Respuestas

### C√≥digos de Estado HTTP
- **200**: √âxito
- **201**: Recurso creado exitosamente
- **400**: Petici√≥n incorrecta (datos inv√°lidos)
- **401**: No autorizado (token inv√°lido/expirado)
- **403**: Prohibido (sin permisos suficientes)
- **404**: Recurso no encontrado
- **409**: Conflicto (recurso ya existe)
- **429**: Demasiadas peticiones (rate limit)
- **500**: Error interno del servidor

### Formato de Errores
```json
{
  "error": "Descripci√≥n del error",
  "details": "Informaci√≥n adicional (opcional)"
}
```

---

## üîç Notas de Seguridad

### ‚ö†Ô∏è **ADVERTENCIAS IMPORTANTES**:

1. **Categor√≠as y Unidades**: Los endpoints POST, PUT y DELETE est√°n actualmente **SIN PROTECCI√ìN** y deber√≠an requerir autenticaci√≥n de administrador.

2. **Rate Limiting**: Solo est√° aplicado al endpoint de login (`/api/auth/login`) para prevenir ataques de fuerza bruta.

3. **Validaci√≥n de Datos**: Aseg√∫rese de validar todos los datos del cliente antes de procesar las peticiones.

---

## üìä Resumen de Endpoints

### Total de Endpoints Documentados: **67**

**P√∫blicos (üîì)**: 22 endpoints
- Autenticaci√≥n: 1
- Productos: 3 
- Categor√≠as: 5 ‚ö†Ô∏è (POST/PUT/DELETE deber√≠an ser admin)
- Tags: 1
- Unidades: 5 ‚ö†Ô∏è (POST/PUT/DELETE deber√≠an ser admin)
- Estados de Pedido: 3
- Ciudades: 1
- Barrios: 1
- Pagos (callbacks): 4
- Chatbot: 3
- General: 2

**Protegidos con JWT (üîí)**: 45 endpoints
- Autenticaci√≥n: 2
- Carrito: 5
- Clientes: 7
- Direcciones: 5
- Cupones: 5
- Pagos: 8
- Pedidos/Ventas: 4
- Chatbot: 5
- Admin: 34

---

## üöÄ Para Empezar

1. **Instalar dependencias**: `npm install`
2. **Configurar variables de entorno**: Copiar `.env.example` a `.env`
3. **Iniciar MongoDB**: `docker-compose up -d mongo`
4. **Ejecutar en desarrollo**: `npm run dev`
5. **La API estar√° disponible en**: `http://localhost:3000`

---

## üìù Changelog de Documentaci√≥n

- **‚úÖ Completado**: Documentaci√≥n exhaustiva de todos los 67 endpoints de la API
- **‚úÖ Identificadas**: Vulnerabilidades de seguridad en endpoints de Categor√≠as y Unidades
- **‚úÖ Agregado**: Documentaci√≥n para Cart, Addresses, Customers, Coupons, Payments, Chatbot y Admin
- **‚úÖ Corregido**: Documentaci√≥n incorrecta de endpoints admin vs p√∫blicos
- **‚úÖ A√±adido**: Endpoints generales de salud del servidor
