# ü§ñ Sistema MCP Completo - Documentaci√≥n Final

## üìã Resumen Ejecutivo

El **Model Context Protocol (MCP)** es un sistema integral implementado para el e-commerce que proporciona:

- ü§ñ **Integraci√≥n con Claude AI** con guardarriles optimizados
- üõ†Ô∏è **Herramientas de datos** para productos, clientes y pedidos  
- üõ°Ô∏è **Sistema de seguridad** que mantiene el foco en e-commerce
- üìä **Monitoreo y estad√≠sticas** avanzadas
- üÖ∞Ô∏è **Documentaci√≥n Angular** para implementaci√≥n frontend

---

## üéØ Estado Actual (25 Julio 2025)

### ‚úÖ **Implementado y Funcionando**

#### **Sistema MCP Core**
- ‚úÖ Proxy Anthropic con modelos Claude actualizados
- ‚úÖ Herramientas de b√∫squeda de productos y clientes
- ‚úÖ Sistema de health check y descubrimiento de herramientas
- ‚úÖ Endpoints REST completos y documentados

#### **Guardarriles Optimizados**
- ‚úÖ Configuraci√≥n flexible (`strictMode: false`)
- ‚úÖ Permite consultas generales de e-commerce
- ‚úÖ Bloquea contenido no relacionado (pol√≠tica, religi√≥n, etc.)
- ‚úÖ Sistema de sesiones con l√≠mites apropiados

#### **Monitoreo Avanzado**
- ‚úÖ Logging estructurado de todas las consultas
- ‚úÖ Estad√≠sticas detalladas de uso y bloqueos
- ‚úÖ Clasificaci√≥n autom√°tica de tipos de consulta
- ‚úÖ Tracking de sesiones activas

#### **Documentaci√≥n Completa**
- ‚úÖ Gu√≠as Angular con interfaces TypeScript
- ‚úÖ Ejemplos de consultas v√°lidas vs bloqueadas
- ‚úÖ Documentaci√≥n de endpoints y configuraci√≥n

---

## üîå Endpoints Principales

### **Health & Discovery**
```bash
GET /api/mcp/health                # Estado del sistema
GET /api/mcp/models               # Modelos Claude disponibles
GET /api/mcp/tools/info           # Informaci√≥n de herramientas
```

### **Herramientas MCP**
```bash
POST /api/mcp/tools/call          # Ejecutar herramienta
POST /api/mcp/anthropic           # Chat con Claude AI
```

### **Guardarriles y Monitoreo**
```bash
GET /api/mcp/guardrails/config    # Configuraci√≥n actual
GET /api/mcp/guardrails/stats     # Estad√≠sticas detalladas
GET /api/mcp/guardrails/sessions  # Sesiones activas
POST /api/mcp/guardrails/stats/reset        # Reiniciar estad√≠sticas
POST /api/mcp/guardrails/sessions/cleanup   # Limpiar sesiones
```

---

## üìä Tipos de Consultas Soportadas

### ‚úÖ **Consultas Permitidas**

#### **1. E-commerce General** (Sin herramientas requeridas)
```bash
# Ejemplos:
"¬øQu√© tipos de productos venden?"
"¬øC√≥mo funciona el proceso de pedidos?"
"¬øCu√°les son las formas de pago disponibles?"
"¬øQu√© informaci√≥n necesito para hacer un pedido?"
```

#### **2. B√∫squedas Espec√≠ficas** (Con herramientas MCP)
```bash
# Ejemplos:
"Busca productos de lomito con precios exactos"
"¬øCu√°ntos clientes tenemos en el barrio X?"
"Mu√©strame los pedidos de hoy"
"Encuentra el producto m√°s vendido"
```

### ‚ùå **Consultas Bloqueadas**
- Pol√≠tica, religi√≥n, noticias generales
- Entretenimiento no relacionado con e-commerce  
- Informaci√≥n personal sensible
- Temas controvertidos o da√±inos

---

## üìà Sistema de Monitoreo

### **Estad√≠sticas Capturadas**
```json
{
  "activeSessions": 3,
  "totalRequests": 156,
  "allowedRequests": 142,
  "blockedRequests": 14,
  "allowedRate": "91.03%",
  "blockReasons": {
    "blocked_content": 8,
    "session_limit": 4,
    "tools_required": 2
  },
  "uptime": "120.5 minutos",
  "topSessionIds": [
    {"id": "session-1", "messageCount": 25},
    {"id": "session-2", "messageCount": 18}
  ]
}
```

### **Clasificaci√≥n de Consultas**
- `search_query`: B√∫squedas espec√≠ficas
- `product_query`: Consultas sobre productos
- `customer_query`: Consultas sobre clientes
- `order_query`: Consultas sobre pedidos
- `pricing_query`: Consultas sobre precios
- `general_ecommerce`: Consultas generales de e-commerce

### **Logging Estructurado**
```json
{
  "timestamp": "2025-07-25T14:55:54.610Z",
  "level": "info",
  "message": "MCP Guardrails - Request processed",
  "sessionId": "angular-session-123",
  "action": "allowed",
  "reason": "valid_ecommerce_query",
  "model": "claude-3-5-sonnet-20241022",
  "messageCount": 1,
  "hasTools": false,
  "queryType": "general_ecommerce",
  "service": "mcp-guardrails"
}
```

---

## üÖ∞Ô∏è Implementaci√≥n Frontend (Angular)

### **Servicios Principales**

#### **McpService**
```typescript
@Injectable({ providedIn: 'root' })
export class McpService {
  // Health check, modelos, herramientas
  checkHealth(): Observable<MCPResponse>
  getModels(): Observable<MCPResponse<AnthropicModel[]>>
  getToolsInfo(): Observable<MCPResponse<{ tools: MCPTool[] }>>
  
  // Chat con Claude
  chatWithAnthropic(request: AnthropicRequest, sessionId?: string): Observable<AnthropicResponse>
  
  // Guardarriles
  getGuardrailsConfig(): Observable<MCPResponse<GuardrailsConfig>>
  getGuardrailsStats(): Observable<MCPResponse<GuardrailsStats>>
}
```

#### **GuardrailsService** (Nuevo)
```typescript
@Injectable({ providedIn: 'root' })
export class GuardrailsService {
  // Gesti√≥n de sesiones
  getCurrentSessionId(): string
  renewSession(): string
  
  // Validaci√≥n local
  isValidEcommerceQuery(query: string): boolean
  
  // Chat con validaci√≥n autom√°tica
  chatWithValidation(request: AnthropicRequest): Observable<AnthropicResponse | GuardrailsError>
}
```

### **Interfaces TypeScript Actualizadas**
```typescript
// Interfaces con soporte para guardarriles
export interface AnthropicResponse {
  id: string;
  content: Array<{ type: string; text?: string; }>;
  _guardrails?: {
    sessionId: string;
    processed: boolean;
    timestamp: string;
  };
}

export interface GuardrailsError {
  error: string;
  reason: 'blocked_content' | 'tools_required' | 'session_limit';
  message: string;
  suggestions: string;
}
```

---

## üõ†Ô∏è Configuraci√≥n y Personalizaci√≥n

### **Variables de Entorno Requeridas**
```env
# Anthropic
ANTHROPIC_API_KEY=your_anthropic_api_key

# MCP Guardrails
MCP_GUARDRAILS_ENABLED=true
MCP_STRICT_MODE=false
MCP_MAX_TOKENS=1024
MCP_MAX_MESSAGES_PER_SESSION=50
MCP_SESSION_DURATION_MINUTES=30
```

### **Configuraci√≥n de Guardarriles**
```typescript
// src/configs/mcp-guardrails.ts
export const MCP_GUARDRAILS_CONFIG = {
  enabled: true,
  strictMode: false,           // ‚úÖ Optimizado
  limits: {
    requiredTools: false,      // ‚úÖ Permite consultas generales
    maxTokens: 1024,
    maxMessagesPerSession: 50,
    maxSessionDuration: 30,
    allowedTopics: [...],
    blockedKeywords: [...]
  }
};
```

---

## üöÄ C√≥mo Probar el Sistema

### **1. Verificar Estado**
```bash
curl -s http://localhost:3000/api/mcp/health
```

### **2. Consulta General de E-commerce** (Permitida)
```bash
curl -X POST http://localhost:3000/api/mcp/anthropic \
  -H "Content-Type: application/json" \
  -H "x-session-id: test-session" \
  -d '{
    "model": "claude-3-5-sonnet-20241022",
    "max_tokens": 200,
    "messages": [
      {
        "role": "user",
        "content": "¬øQu√© tipos de productos de comida venden?"
      }
    ]
  }'
```

### **3. B√∫squeda con Herramientas**
```bash
curl -X POST http://localhost:3000/api/mcp/tools/call \
  -H "Content-Type: application/json" \
  -d '{
    "toolName": "get_products",
    "args": {
      "search": "lomito",
      "limit": 3
    }
  }'
```

### **4. Consulta Bloqueada** (Pol√≠tica)
```bash
curl -X POST http://localhost:3000/api/mcp/anthropic \
  -H "Content-Type: application/json" \
  -H "x-session-id: test-blocked" \
  -d '{
    "model": "claude-3-5-sonnet-20241022",
    "max_tokens": 100,
    "messages": [
      {
        "role": "user",
        "content": "¬øQu√© opinas sobre las elecciones pol√≠ticas?"
      }
    ]
  }'
```

### **5. Ver Estad√≠sticas**
```bash
curl -s http://localhost:3000/api/mcp/guardrails/stats
```

---

## üìã Resultados Esperados

### ‚úÖ **Consulta General Permitida**
```json
{
  "id": "msg_...",
  "content": [
    {
      "type": "text",
      "text": "Ofrecemos una variedad de productos de comida incluyendo lomitos, empanadas, pizzas..."
    }
  ],
  "_guardrails": {
    "sessionId": "test-session",
    "processed": true,
    "timestamp": "2025-07-25T..."
  }
}
```

### ‚ùå **Consulta Bloqueada**
```json
{
  "error": "Request blocked by guardrails",
  "reason": "blocked_content",
  "message": "No puedo ayudarte con ese tema. Mi funci√≥n es asistir exclusivamente con consultas del e-commerce...",
  "suggestions": "..."
}
```

---

## üîÆ Pr√≥ximos Pasos Recomendados

### **Corto Plazo**
- [ ] Dashboard web para monitoreo de estad√≠sticas
- [ ] Alertas autom√°ticas por alto volumen de bloqueos
- [ ] Integraci√≥n con sistema de notificaciones existente

### **Mediano Plazo**
- [ ] Cache Redis para respuestas frecuentes
- [ ] A/B testing de configuraciones de guardarriles
- [ ] M√©tricas de satisfacci√≥n del usuario

### **Largo Plazo**
- [ ] Machine Learning para clasificaci√≥n autom√°tica
- [ ] Integraci√≥n con m√°s modelos de IA
- [ ] Sistema de feedback para mejorar guardarriles

---

## üìû Soporte y Mantenimiento

### **Logs Importantes**
```bash
# Logs de guardarriles
tail -f logs/combined-{env}-{date}.log | grep "mcp-guardrails"

# Consultas bloqueadas
grep "Request blocked" logs/combined-{env}-{date}.log

# Estad√≠sticas por hora
grep "$(date +%Y-%m-%d)" logs/combined-{env}-{date}.log | grep "MCP Guardrails"
```

### **Comandos de Mantenimiento**
```bash
# Limpiar sesiones expiradas
curl -X POST http://localhost:3000/api/mcp/guardrails/sessions/cleanup

# Reiniciar estad√≠sticas
curl -X POST http://localhost:3000/api/mcp/guardrails/stats/reset

# Ver configuraci√≥n actual
curl -s http://localhost:3000/api/mcp/guardrails/config
```

---

## üéâ Conclusi√≥n

El sistema MCP est√° **completo y optimizado** para proporcionar:

- ‚úÖ **Flexibilidad**: Permite consultas generales y espec√≠ficas
- ‚úÖ **Seguridad**: Mantiene restricciones apropiadas
- ‚úÖ **Monitoreo**: Estad√≠sticas detalladas y logging
- ‚úÖ **Escalabilidad**: Arquitectura preparada para crecimiento
- ‚úÖ **Mantenibilidad**: Documentaci√≥n completa y APIs bien definidas

**El sistema est√° listo para producci√≥n y uso en el frontend Angular.** üöÄ

---

*Documentaci√≥n actualizada: 25 Julio 2025*  
*Versi√≥n: 2.0 - Sistema Optimizado*
